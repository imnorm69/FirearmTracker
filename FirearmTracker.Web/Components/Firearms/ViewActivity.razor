@page "/firearms/{FirearmId:int}/activity/{ActivityId:int}"
@using FirearmTracker.Core.Interfaces
@using FirearmTracker.Core.Models
@using FirearmTracker.Core.Enums
@using System.Text.Json
@using FirearmTracker.Web.Components
@inject IActivityRepository ActivityRepository
@inject IFirearmRepository FirearmRepository
@inject NavigationManager Navigation
@inject IDocumentRepository DocumentRepository
@rendermode InteractiveServer

<link href="css/firearms.css" rel="stylesheet" />

<div class="form-container">
    @if (activity == null || firearm == null)
    {
        <div class="loading">Loading...</div>
    }
    else
    {
        <h3 class="firearms-header">@GetActivityTypeName(activity.ActivityType) Details</h3>
        
        <p><strong>Firearm:</strong> @firearm.Manufacturer @firearm.Model</p>

        <div class="form-paper">
            <div class="detail-section">
                <div class="detail-row">
                    <span class="detail-label">Activity Type:</span>
                    <span class="detail-value">@GetActivityIcon(activity.ActivityType) @activity.ActivityType</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">@activity.ActivityDate.ToLongDateString()</span>
                </div>

                @if (activity.Amount.HasValue)
                {
                    <div class="detail-row">
                        <span class="detail-label">Amount:</span>
                        <span class="detail-value">@activity.Amount.Value.ToString("C")</span>
                    </div>
                }

                <div class="detail-row">
                    <span class="detail-label">Description:</span>
                    <span class="detail-value">@activity.Description</span>
                </div>

                @if (!string.IsNullOrEmpty(activity.Notes))
                {
                    <div class="detail-row">
                        <span class="detail-label">Notes:</span>
                        <span class="detail-value">@activity.Notes</span>
                    </div>
                }

                @RenderActivitySpecificDetails(activity)
            </div>

            <div class="form-actions">
                <button @onclick="BackToDetail" class="btn-icon-only" title="Back to Firearm">
            <Icon Name="back" />
        </button>
                <button @onclick="EditActivity" class="btn-icon-only" title="Edit Activity">
            <Icon Name="edit" />
        </button>
                <button @onclick="ConfirmDelete" class="btn-icon-only" title="Delete Activity">
            <Icon Name="delete" />
        </button>
            </div>

            <DocumentUpload ActivityId="@ActivityId" />

            @if (showDeleteConfirmation)
            {
                <div class="confirmation-overlay">
                    <div class="confirmation-dialog">
                        <h4>Confirm Delete</h4>
                        <p>Are you sure you want to delete this @activity.ActivityType activity?</p>
                        <p><strong>This action cannot be undone.</strong></p>
                        <div class="confirmation-actions">
                            <button @onclick="DeleteActivity" class="btn-icon-only" title="Yes, Delete">
            <Icon Name="delete" />
        </button>
                            <button @onclick="CancelDelete" class="btn-icon-only" title="Cancel">
            <Icon Name="back" />
        </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int FirearmId { get; set; }

    [Parameter]
    public int ActivityId { get; set; }

    private Activity? activity;
    private Firearm? firearm;
    private bool showDeleteConfirmation = false;

    protected override async Task OnInitializedAsync()
    {
        activity = await ActivityRepository.GetByIdAsync(ActivityId);
        firearm = await FirearmRepository.GetByIdAsync(FirearmId);
        
        if (activity == null || firearm == null || activity.FirearmId != FirearmId)
        {
            Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
        }
    }

    private RenderFragment RenderActivitySpecificDetails(Activity act) => builder =>
    {
        if (string.IsNullOrEmpty(act.AdditionalData)) return;

        try
        {
            switch (act.ActivityType)
            {
                case ActivityType.Purchase:
                    var purchaseData = JsonSerializer.Deserialize<PurchaseActivityData>(act.AdditionalData);
                    if (purchaseData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Purchase Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Purchased From Type:", purchaseData.PurchasedFromType);
                        RenderDetailRow(builder, "Purchased From:", purchaseData.PurchasedFromName);
                        if (!string.IsNullOrEmpty(purchaseData.StreetAddress))
                            RenderDetailRow(builder, "Address:", purchaseData.StreetAddress);
                        if (!string.IsNullOrEmpty(purchaseData.City))
                            RenderDetailRow(builder, "City:", purchaseData.City);
                        if (!string.IsNullOrEmpty(purchaseData.State))
                            RenderDetailRow(builder, "State:", purchaseData.State);
                        if (!string.IsNullOrEmpty(purchaseData.ZipCode))
                            RenderDetailRow(builder, "ZIP:", purchaseData.ZipCode);
                        if (!string.IsNullOrEmpty(purchaseData.Phone))
                            RenderDetailRow(builder, "Phone:", purchaseData.Phone);
                        if (!string.IsNullOrEmpty(purchaseData.Email))
                            RenderDetailRow(builder, "Email:", purchaseData.Email);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.Sale:
                    var saleData = JsonSerializer.Deserialize<SaleActivityData>(act.AdditionalData);
                    if (saleData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Sale Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Sold To Type:", saleData.SoldToType);
                        RenderDetailRow(builder, "Sold To:", saleData.SoldToName);
                        if (!string.IsNullOrEmpty(saleData.StreetAddress))
                            RenderDetailRow(builder, "Address:", saleData.StreetAddress);
                        if (!string.IsNullOrEmpty(saleData.City))
                            RenderDetailRow(builder, "City:", saleData.City);
                        if (!string.IsNullOrEmpty(saleData.State))
                            RenderDetailRow(builder, "State:", saleData.State);
                        if (!string.IsNullOrEmpty(saleData.ZipCode))
                            RenderDetailRow(builder, "ZIP:", saleData.ZipCode);
                        if (!string.IsNullOrEmpty(saleData.Phone))
                            RenderDetailRow(builder, "Phone:", saleData.Phone);
                        if (!string.IsNullOrEmpty(saleData.Email))
                            RenderDetailRow(builder, "Email:", saleData.Email);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.RepairDIY:
                    var repairDIYData = JsonSerializer.Deserialize<RepairDIYActivityData>(act.AdditionalData);
                    if (repairDIYData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "DIY Repair Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Work Performed:", repairDIYData.Description);
                        if (repairDIYData.Cost.HasValue)
                            RenderDetailRow(builder, "Parts/Supplies Cost:", repairDIYData.Cost.Value.ToString("C"));
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.RepairVendor:
                    var repairVendorData = JsonSerializer.Deserialize<RepairVendorActivityData>(act.AdditionalData);
                    if (repairVendorData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Professional Repair Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Vendor:", repairVendorData.VendorName);
                        RenderDetailRow(builder, "Work Performed:", repairVendorData.Description);
                        if (!string.IsNullOrEmpty(repairVendorData.Address))
                            RenderDetailRow(builder, "Address:", repairVendorData.Address);
                        if (!string.IsNullOrEmpty(repairVendorData.Phone))
                            RenderDetailRow(builder, "Phone:", repairVendorData.Phone);
                        if (!string.IsNullOrEmpty(repairVendorData.Email))
                            RenderDetailRow(builder, "Email:", repairVendorData.Email);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.AppraisalSelf:
                    var appraisalSelfData = JsonSerializer.Deserialize<AppraisalSelfActivityData>(act.AdditionalData);
                    if (appraisalSelfData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Self Appraisal Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Source:", appraisalSelfData.SourceOfInformation);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.AppraisalProfessional:
                    var appraisalProfData = JsonSerializer.Deserialize<AppraisalProfessionalActivityData>(act.AdditionalData);
                    if (appraisalProfData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Professional Appraisal Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Appraiser:", appraisalProfData.AppraiserName);
                        if (!string.IsNullOrEmpty(appraisalProfData.BusinessName))
                            RenderDetailRow(builder, "Business:", appraisalProfData.BusinessName);
                        if (!string.IsNullOrEmpty(appraisalProfData.Credentials))
                            RenderDetailRow(builder, "Credentials:", appraisalProfData.Credentials);
                        if (!string.IsNullOrEmpty(appraisalProfData.Address))
                            RenderDetailRow(builder, "Address:", appraisalProfData.Address);
                        if (!string.IsNullOrEmpty(appraisalProfData.Phone))
                            RenderDetailRow(builder, "Phone:", appraisalProfData.Phone);
                        if (!string.IsNullOrEmpty(appraisalProfData.Email))
                            RenderDetailRow(builder, "Email:", appraisalProfData.Email);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.RangeSession:
                    var rangeData = JsonSerializer.Deserialize<RangeSessionActivityData>(act.AdditionalData);
                    if (rangeData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Range Session Details");
                        builder.CloseElement();
                        
                        if (rangeData.RoundsFired.HasValue)
                            RenderDetailRow(builder, "Rounds Fired:", rangeData.RoundsFired.Value.ToString());
                        if (!string.IsNullOrEmpty(rangeData.LocationName))
                            RenderDetailRow(builder, "Location:", rangeData.LocationName);
                        if (!string.IsNullOrEmpty(rangeData.AmmunitionType))
                            RenderDetailRow(builder, "Ammunition:", rangeData.AmmunitionType);
                        if (!string.IsNullOrEmpty(rangeData.PerformanceNotes))
                            RenderDetailRow(builder, "Performance Notes:", rangeData.PerformanceNotes);
                        RenderDetailRow(builder, "Cleaned After Session:", rangeData.CleanedAfterSession ? "Yes" : "No");
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.Modification:
                    var modData = JsonSerializer.Deserialize<ModificationActivityData>(act.AdditionalData);
                    if (modData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Modification Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Part/Accessory:", modData.AccessoryPartName);
                        RenderDetailRow(builder, "Installed By:", modData.InstalledBy);
                        if (!string.IsNullOrEmpty(modData.VendorInstallerName))
                            RenderDetailRow(builder, "Installer:", modData.VendorInstallerName);
                        if (!string.IsNullOrEmpty(modData.Description))
                            RenderDetailRow(builder, "Description:", modData.Description);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.Insurance:
                    var insuranceData = JsonSerializer.Deserialize<InsuranceActivityData>(act.AdditionalData);
                    if (insuranceData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Insurance Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Insurance Company:", insuranceData.InsuranceCompany);
                        if (!string.IsNullOrEmpty(insuranceData.PolicyNumber))
                            RenderDetailRow(builder, "Policy Number:", insuranceData.PolicyNumber);
                        if (insuranceData.ExpirationDate.HasValue)
                            RenderDetailRow(builder, "Expiration Date:", insuranceData.ExpirationDate.Value.ToShortDateString());
                        if (!string.IsNullOrEmpty(insuranceData.CompanyContact))
                            RenderDetailRow(builder, "Contact Info:", insuranceData.CompanyContact);
                        
                        builder.CloseElement();
                    }
                    break;

                case ActivityType.Transfer:
                    var transferData = JsonSerializer.Deserialize<TransferActivityData>(act.AdditionalData);
                    if (transferData != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "detail-subsection");
                        builder.OpenElement(2, "h5");
                        builder.AddContent(3, "Transfer Details");
                        builder.CloseElement();
                        
                        RenderDetailRow(builder, "Transfer Type:", transferData.TransferType);
                        RenderDetailRow(builder, "From:", transferData.FromWhom);
                        if (!string.IsNullOrEmpty(transferData.Description))
                            RenderDetailRow(builder, "Description:", transferData.Description);
                        
                        builder.CloseElement();
                    }
                    break;
            }
        }
        catch (Exception)
        {
            // Silently handle JSON deserialization errors
        }
    };

    private void RenderDetailRow(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, string label, string value)
    {
        if (string.IsNullOrWhiteSpace(value)) return;
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "detail-row");
        
        builder.OpenElement(2, "span");
        builder.AddAttribute(3, "class", "detail-label");
        builder.AddContent(4, label);
        builder.CloseElement();
        
        builder.OpenElement(5, "span");
        builder.AddAttribute(6, "class", "detail-value");
        builder.AddContent(7, value);
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private void BackToDetail()
    {
        Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
    }

    private void ConfirmDelete()
    {
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
    }

    private async Task DeleteActivity()
    {
        if (activity != null)
        {
            await ActivityRepository.DeleteAsync(activity.Id);
            Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
        }
    }

    private string GetActivityTypeName(ActivityType type)
    {
        return type switch
        {
            ActivityType.RepairDIY => "DIY Repair/Maintenance",
            ActivityType.RepairVendor => "Professional Repair",
            ActivityType.AppraisalSelf => "Self Appraisal",
            ActivityType.AppraisalProfessional => "Professional Appraisal",
            ActivityType.RangeSession => "Range Session",
            _ => type.ToString()
        };
    }

    private string GetActivityIcon(ActivityType activityType)
    {
        return activityType switch
        {
            ActivityType.Purchase => "💰",
            ActivityType.Sale => "💵",
            ActivityType.RepairDIY => "🔧",
            ActivityType.RepairVendor => "🛠️",
            ActivityType.AppraisalSelf => "📊",
            ActivityType.AppraisalProfessional => "📋",
            ActivityType.RangeSession => "🎯",
            ActivityType.Modification => "⚙️",
            ActivityType.Insurance => "🛡️",
            ActivityType.Transfer => "🔄",
            _ => "📝"
        };
    }
    private void EditActivity()
    {
        if (activity != null)
        {
            var route = activity.ActivityType switch
            {
                ActivityType.Purchase => "purchase",
                ActivityType.Sale => "sale",
                ActivityType.RepairDIY => "repair-diy",
                ActivityType.RepairVendor => "repair-vendor",
                ActivityType.AppraisalSelf => "appraisal-self",
                ActivityType.AppraisalProfessional => "appraisal-professional",
                ActivityType.RangeSession => "range-session",
                ActivityType.Modification => "modification",
                ActivityType.Insurance => "insurance",
                ActivityType.Transfer => "transfer",
                _ => "purchase"
            };
        
            Navigation.NavigateTo($"/firearms/{FirearmId}/{route}/{ActivityId}/edit");
        }
    }
}