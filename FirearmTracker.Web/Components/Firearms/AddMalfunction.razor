@page "/firearms/{FirearmId:int}/malfunction/add"
@page "/firearms/{FirearmId:int}/malfunction/{ActivityId:int}/edit"
@attribute [Authorize(Roles = "Owner,Administrator,PowerUser")]
@using FirearmTracker.Core.Interfaces
@using FirearmTracker.Core.Models
@using FirearmTracker.Core.Enums
@using System.Text.Json
@using FirearmTracker.Web.Components
@inject IActivityRepository ActivityRepository
@inject IFirearmRepository FirearmRepository
@inject NavigationManager Navigation
@rendermode InteractiveServer

<link href="css/firearms.css" rel="stylesheet" />

<div class="form-container">
    <h3 class="firearms-header">@(isEditMode ? "Edit" : "Record") Malfunction</h3>

    @if (firearm != null)
    {
        <p><strong>Firearm:</strong> @firearm.Manufacturer @firearm.Model</p>
    }

    <div class="form-paper">
        <div class="form-group">
            <label>Date *</label>
            <input type="date" @bind="activityDate" class="form-control" />
        </div>

        <div class="form-group">
            <label>Malfunction Type *</label>
            <select @bind="malfunctionData.MalfunctionType" class="form-control">
                <option value="">Select...</option>
                <option value="Failure to Feed">Failure to Feed</option>
                <option value="Failure to Eject">Failure to Eject</option>
                <option value="Failure to Fire">Failure to Fire</option>
                <option value="Light Strike">Light Strike</option>
                <option value="Stovepipe">Stovepipe</option>
                <option value="Double Feed">Double Feed</option>
                <option value="Hang Fire">Hang Fire</option>
                <option value="Squib Load">Squib Load</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Description *</label>
            <textarea @bind="description" class="form-control" rows="3" placeholder="Describe what happened"></textarea>
        </div>

        <div class="form-group">
            <label>Rounds Fired Before Malfunction</label>
            <input type="number" @bind="malfunctionData.RoundsFiredBefore" class="form-control" />
        </div>

        <div class="form-group">
            <label>Ammunition Type Being Used</label>
            <input type="text" @bind="malfunctionData.AmmunitionType" class="form-control" placeholder="e.g., Federal 115gr FMJ" />
        </div>

        <div class="form-group">
            <label>Weather Conditions</label>
            <input type="text" @bind="malfunctionData.WeatherConditions" class="form-control" placeholder="e.g., Hot, Cold, Rain, etc." />
        </div>

        <div class="form-group">
            <label>Resolution/Action Taken</label>
            <textarea @bind="malfunctionData.ResolutionAction" class="form-control" rows="3" placeholder="What did you do to resolve it?"></textarea>
        </div>

        <div class="form-group">
            <label>Additional Notes</label>
            <textarea @bind="notes" class="form-control" rows="4"></textarea>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
            </div>
        }

        <div class="form-actions">
            <button @onclick="SaveMalfunction" class="btn-icon-only" title="Save">
            <Icon Name="save" />
        </button>
            <button @onclick="Cancel" class="btn-icon-only" title="Cancel">
            <Icon Name="back" />
        </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int FirearmId { get; set; }

    [Parameter]
    public int? ActivityId { get; set; }

    private Firearm? firearm;
    private Activity? existingActivity;
    private DateTime? activityDate;
    private string description = string.Empty;
    private string notes = string.Empty;
    private string errorMessage = string.Empty;
    private MalfunctionActivityData malfunctionData = new();
    private bool isEditMode => ActivityId.HasValue;

    protected override async Task OnInitializedAsync()
    {
        firearm = await FirearmRepository.GetByIdAsync(FirearmId);
        if (firearm == null)
        {
            Navigation.NavigateTo("/firearms");
            return;
        }

        if (isEditMode)
        {
            existingActivity = await ActivityRepository.GetByIdAsync(ActivityId!.Value);
            if (existingActivity == null || existingActivity.ActivityType != ActivityType.Malfunction)
            {
                Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
                return;
            }

            activityDate = existingActivity.ActivityDate;
            description = existingActivity.Description;
            notes = existingActivity.Notes;

            if (!string.IsNullOrEmpty(existingActivity.AdditionalData))
            {
                try
                {
                    malfunctionData = JsonSerializer.Deserialize<MalfunctionActivityData>(existingActivity.AdditionalData) ?? new();
                }
                catch
                {
                    malfunctionData = new();
                }
            }
        }
    }

    private async Task SaveMalfunction()
    {
        errorMessage = string.Empty;

        if (!activityDate.HasValue)
        {
            errorMessage = "Date is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(malfunctionData.MalfunctionType))
        {
            errorMessage = "Malfunction Type is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(description))
        {
            errorMessage = "Description is required";
            return;
        }

        try
        {
            if (isEditMode && existingActivity != null)
            {
                existingActivity.ActivityDate = activityDate.Value;
                existingActivity.Description = description;
                existingActivity.Notes = notes;
                existingActivity.AdditionalData = JsonSerializer.Serialize(malfunctionData);

                await ActivityRepository.UpdateAsync(existingActivity);
            }
            else
            {
                var activity = new Activity
                {
                    FirearmId = FirearmId,
                    ActivityType = ActivityType.Malfunction,
                    ActivityDate = activityDate.Value,
                    Description = description,
                    Notes = notes,
                    AdditionalData = JsonSerializer.Serialize(malfunctionData)
                };

                await ActivityRepository.AddAsync(activity);
            }

            Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving malfunction: {ex.Message}";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/firearms/detail/{FirearmId}");
    }
}