@rendermode InteractiveServer
@using FirearmTracker.Core.Interfaces
@using FirearmTracker.Core.Models
@using FirearmTracker.Web.Services
@inject IUserRepository UserRepository
@inject IJSRuntime JSRuntime
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation
@inject IAuthenticationService AuthenticationService

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Users</h4>
    <button class="btn btn-primary" @onclick="ShowAddUser">
        <Icon Name="add" /> Add User
    </button>
</div>

@if (users == null)
{
    <p><em>Loading...</em></p>
}
else if (!users.Any())
{
    <p>No users found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in users)
                {
                    <tr>
                        <td>@user.Username</td>
                        <td>@user.Email</td>
                        <td>@UserRoles.GetRoleDisplayName(user.Role)</td>
                        <td>@user.CreatedDate.ToLocalTime().ToString("g")</td>
                        <td>@(user.LastLoginDate?.ToLocalTime().ToString("g") ?? "Never")</td>
                        <td>
                            @if (user.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => EditUser(user.Id)">
                                <Icon Name="edit" /> Edit
                            </button>
                            @if (user.IsActive && user.Role != UserRoles.Owner)
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeactivateUser(user)">
                                    <Icon Name="delete" /> Deactivate
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (showForm)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingUserId.HasValue ? "Edit User" : "Add New User")</h5>
                    <button type="button" class="btn-close" @onclick="HideForm"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" @bind="username" disabled="@editingUserId.HasValue" />
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" class="form-control" @bind="email" />
                    </div>

                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select id="role" class="form-select" @bind="role" disabled="@isOwner">
                            @if (isOwner)
                            {
                                <option value="@UserRoles.Owner">@UserRoles.GetRoleDisplayName(UserRoles.Owner)</option>
                            }
                            else
                            {
                                @foreach (var r in UserRoles.AllRoles.Where(r => r != UserRoles.Owner))
                                {
                                    <option value="@r">@UserRoles.GetRoleDisplayName(r)</option>
                                }
                            }
                        </select>
                        @if (isOwner)
                        {
                            <small class="form-text text-muted">Owner role cannot be changed.</small>
                        }
                    </div>

                    @if (!editingUserId.HasValue || changePassword)
                    {
                        <div class="mb-3">
                            <label for="password" class="form-label">@(editingUserId.HasValue ? "New Password" : "Password")</label>
                            <input type="password" id="password" class="form-control" @bind="password" />
                            @if (!editingUserId.HasValue)
                            {
                                <small class="form-text text-muted">Minimum 8 characters</small>
                            }
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="form-control" @bind="confirmPassword" />
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => changePassword = true">
                                Change Password
                            </button>
                        </div>
                    }

                    @if (editingUserId.HasValue)
                    {
                        <div class="mb-3 form-check">
                            <input type="checkbox" id="isActive" class="form-check-input" @bind="isActive" />
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                    }

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" @onclick="HideForm">
                            <Icon Name="cancel" /> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="HandleSubmit" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <Icon Name="save" /> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<User>? users;
    private bool showForm = false;
    private int? editingUserId;
    private string? errorMessage;
    private bool isSaving;
    private bool changePassword;

    // Form fields
    private string username = string.Empty;
    private string email = string.Empty;
    private string role = UserRoles.PowerUser;
    private string password = string.Empty;
    private string confirmPassword = string.Empty;
    private bool isActive = true;

    private bool isOwner => editingUserId.HasValue && role == UserRoles.Owner;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users = (await UserRepository.GetAllAsync()).ToList();
    }

    private void ShowAddUser()
    {
        ResetForm();
        showForm = true;
        editingUserId = null;
    }

    private async Task EditUser(int userId)
    {
        var user = await UserRepository.GetByIdAsync(userId);
        if (user != null)
        {
            editingUserId = userId;
            username = user.Username;
            email = user.Email;
            role = user.Role;
            isActive = user.IsActive;
            password = string.Empty;
            confirmPassword = string.Empty;
            changePassword = false;
            showForm = true;
        }
    }

    private async Task DeactivateUser(User user)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to deactivate user '{user.Username}'?"))
        {
            await UserRepository.DeleteAsync(user.Id);
            await LoadUsers();
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = null;

        // Validate password if it's being set
        if (!string.IsNullOrEmpty(password))
        {
            if (password.Length < 8)
            {
                errorMessage = "Password must be at least 8 characters.";
                return;
            }

            if (password != confirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }
        }
        else if (!editingUserId.HasValue)
        {
            errorMessage = "Password is required for new users.";
            return;
        }

        // Check username uniqueness
        if (!editingUserId.HasValue)
        {
            if (await UserRepository.UsernameExistsAsync(username))
            {
                errorMessage = "Username already exists.";
                return;
            }
        }
        else
        {
            if (await UserRepository.UsernameExistsAsync(username, editingUserId.Value))
            {
                errorMessage = "Username already exists.";
                return;
            }
        }

        isSaving = true;

        try
        {
            if (editingUserId.HasValue)
            {
                // Update existing user
                var user = await UserRepository.GetByIdAsync(editingUserId.Value);
                if (user != null)
                {
                    user.Email = email;
                    user.Role = role;
                    user.IsActive = isActive;

                    if (!string.IsNullOrEmpty(password))
                    {
                        user.PasswordHash = AuthenticationService.HashPassword(password);                    
                    }

                    await UserRepository.UpdateAsync(user);
                }
            }
            else
            {
                // Create new user
                await AuthenticationService.CreateUserAsync(username, email, password, role);
            }

            HideForm();
            await LoadUsers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving user: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void HideForm()
    {
        showForm = false;
        ResetForm();
    }

    private void ResetForm()
    {
        username = string.Empty;
        email = string.Empty;
        role = UserRoles.PowerUser;
        password = string.Empty;
        confirmPassword = string.Empty;
        isActive = true;
        changePassword = false;
        errorMessage = null;
    }
}